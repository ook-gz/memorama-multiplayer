<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Partidas activas</title>

    <link href="./vendor/bootstrap-select/dist/css/bootstrap-select.min.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
</head>
  <style>
    body {
      background-image: url('./images/fondoranking.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    /* Opcional: para mejorar la legibilidad del contenido */
    .card {
      background-color: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(5px);
    }
    
    .podium-container {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        height: 300px;
        gap: 20px;
        margin-top: 30px;
    }
    .podium-item {
        text-align: center;
        position: relative;
        transition: transform 0.3s ease;
    }
    .podium-item:hover {
        transform: translateY(-10px);
    }
    .podium-place {
        width: 100px;
        background: linear-gradient(145deg, #ffd700, #ffed4e);
        border-radius: 10px 10px 0 0;
        color: #8b7500;
        font-weight: bold;
        padding: 10px;
        font-size: 1.2em;
    }
    .podium-2nd .podium-place {
        background: linear-gradient(145deg, #c0c0c0, #e8e8e8);
        color: #666;
        height: 120px;
    }
    .podium-1st .podium-place {
        background: linear-gradient(145deg, #ffd700, #ffed4e);
        color: #8b7500;
        height: 160px;
    }
    .podium-3rd .podium-place {
        background: linear-gradient(145deg, #cd7f32, #e89c5e);
        color: #8b4513;
        height: 100px;
    }
    .podium-info {
        background: white;
        padding: 15px;
        border-radius: 0 0 10px 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .podium-name {
        font-weight: bold;
        font-size: 1.1em;
        color: #333;
    }
    .podium-time {
        color: #666;
        font-size: 0.9em;
    }
    .podium-badge {
        position: absolute;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        width: 50px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 1.2em;
    }
    .badge-gold {
        background: linear-gradient(145deg, #ffd700, #ff8c00);
    }
    .badge-silver {
        background: linear-gradient(145deg, #c0c0c0, #808080);
    }
    .badge-bronze {
        background: linear-gradient(145deg, #cd7f32, #8b4513);
    }
    .no-data {
        text-align: center;
        color: #666;
        font-size: 1.2em;
        padding: 60px 20px;
    }
    .controls {
        text-align: center;
        margin-top: 30px;
    }
    .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-size: 1em;
        cursor: pointer;
        transition: transform 0.3s ease;
    }
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
  </style>
<body>
  
  <div class="container-fluid">
    <div class="form-head mb-4">
      <!-- <h2 class="text-black font-w600 mb-0">Dashboard</h2> -->
      </br>
      <div class="col-lg-12">
          <div class="card">
              <div class="card-header">
                  <h4 class="card-title">Resumen de partida</h4>
              </div>
              <div class="card-body">
                  <div class="table-responsive">
                      <table class="table table-bordered verticle-middle table-responsive-sm">
                          <thead>
                              <tr>
                                <th>Room ID</th>
                                <th>Jugadores ingresados</th>
                                <th>Cupo máximo</th>
                                <th>Creación</th>
                                <th>Detalle jugadores</th>
                              </tr>
                          </thead>
                          <tbody id="tabla-partidas">
                            <tr><td colspan="6">Cargando...</td></tr>
                          </tbody>

                        
                      </table>
                  </div>
              </div>
          </div>
          
          <div class="card">
              <div class="card-header">
                  <h4 class="card-title">Ranking</h4>
              </div>

              <div class="card-body">
                <div id="podiumContainer"></div>
              </div>
              </div>
          </div>
      </div>
    </div>
  </div>

  <script src="./vendor/global/global.min.js"></script>
	<script src="./vendor/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
  <script src="./vendor/chart.js/Chart.bundle.min.js"></script>
  <!-- <script src="./js/plugins-init/chartjs-init.js"></script> -->
  <script>
    // Función para generar el podio
    const generarPodio = (rankingData) => {
      console.log(rankingData)
        const podiumContainer = document.getElementById('podiumContainer');
        
        // Filtrar y ordenar los 3 primeros
        const top3 = rankingData
            // .filter(j => j.completado)
            .sort((a, b) => a.tiempo - b.tiempo)
            .slice(0, 3);

        if (top3.length === 0) {
            podiumContainer.innerHTML = '<div class="no-data">No hay datos de ranking disponibles</div>';
            return;
        }

        let podiumHTML = '<div class="podium-container">';

        // Segundo lugar
        if (top3[1]) {
            podiumHTML += `
                <div class="podium-item podium-2nd">
                    <div class="podium-badge badge-silver">2°</div>
                    <div class="podium-place">🥈 Segundo</div>
                    <div class="podium-info">
                        <div class="podium-name">${top3[1].nombre}</div>
                        <div class="podium-time">${top3[1].tiempo} seg</div>
                        <div class="podium-sucursal">${top3[1].sucursal}</div>
                    </div>
                </div>
            `;
        }

        // Primer lugar
        if (top3[0]) {
            podiumHTML += `
                <div class="podium-item podium-1st">
                    <div class="podium-badge badge-gold">1°</div>
                    <div class="podium-place">🥇 Primero</div>
                    <div class="podium-info">
                        <div class="podium-name">${top3[0].nombre}</div>
                        <div class="podium-time">${top3[0].tiempo} seg</div>
                        <div class="podium-sucursal">${top3[0].sucursal}</div>
                    </div>
                </div>
            `;
        }

        // Tercer lugar
        if (top3[2]) {
            podiumHTML += `
                <div class="podium-item podium-3rd">
                    <div class="podium-badge badge-bronze">3°</div>
                    <div class="podium-place">🥉 Tercero</div>
                    <div class="podium-info">
                        <div class="podium-name">${top3[2].nombre}</div>
                        <div class="podium-time">${top3[2].tiempo} seg</div>
                        <div class="podium-sucursal">${top3[2].sucursal}</div>
                    </div>
                </div>
            `;
        }

        podiumHTML += '</div>';

        // Lista de otros participantes
        if (rankingData.filter(j => j.completado).length > 3) {
            const otros = rankingData
                .filter(j => j.completado)
                .sort((a, b) => a.tiempo - b.tiempo)
                .slice(3);

            podiumHTML += `
                <div style="margin-top: 40px; text-align: center;">
                    <h3 style="color: #666; margin-bottom: 15px;">Otros Participantes</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                        ${otros.map(jugador => `
                            <div style="background: #f8f9fa; padding: 10px 15px; border-radius: 20px; border: 1px solid #e9ecef; min-width: 120px;">
                                <div style="font-weight: bold; color: #333;">${jugador.nombre}</div>
                                <div style="color: #666; font-size: 0.9em;">${jugador.tiempo} seg</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        podiumContainer.innerHTML = podiumHTML;
    };

    // Función para simular actualización de datos
    const actualizarDatos = () => {
        // Simular nuevos datos (en una aplicación real, harías una petición HTTP)
        console.log("Actualizando datos del ranking...");
        
        location.reload();
    };

    async function cargarPartidas() {
      try {
        const res = await fetch("/api/partidas");
        const partidas = await res.json();
        
        console.log(partidas);

        const tbody = document.getElementById("tabla-partidas");
        if (partidas.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6">No hay partidas activas</td></tr>`;
          return;
        }

        tbody.innerHTML = partidas.map(p => {
          const jugadores = Object.values(p.metadata.jugadores || {});
          const ranking = Object.values(p.metadata.ranking || []);
          const partidaTerminada = p.metadata.partidaTerminada;

          let ganador = jugadores.find(j => j.terminado === true);

          if(partidaTerminada){
            generarPodio(ranking);
          }

          return `
            <tr>
              <td>${p.roomId}</td>
              <td>${p.clients}</td>
              <td>${p.maxClients}</td>
              <td>${new Date(p.createdAt).toLocaleString()}</td>
              <td>
                <ul class="jugadores">
                  ${jugadores.map(j => `<li>${j.nombre} (${j.sucursal}) - Tiempo: ${j.tiempo}s ${j.terminado ? "✅" : ""}</li>`).join("")}
                </ul>
              </td>
            </tr>
          `;
        }).join("");
      } catch (err) {
        console.error("Error cargando partidas:", err);
      }
    }

    // primera carga
    cargarPartidas();
    // refrescar cada 5s
    setInterval(cargarPartidas, 5000);
    

  </script>
</body>
</html>